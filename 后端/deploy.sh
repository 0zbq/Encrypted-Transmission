#!/bin/bash

# éƒ¨ç½²è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: ./deploy.sh

set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åŠ å¯†å›¾ç‰‡ä¼ è¾“æœåŠ¡..."

# æ£€æŸ¥Node.jsç‰ˆæœ¬
echo "ğŸ“‹ æ£€æŸ¥Node.jsç‰ˆæœ¬..."
node --version
npm --version

# å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm ci --production

# åˆ›å»ºå¿…è¦çš„ç›®å½•
echo "ğŸ“ åˆ›å»ºç›®å½•..."
mkdir -p logs
mkdir -p storage

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
if [ ! -f .env ]; then
    echo "âš ï¸  .envæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å¤åˆ¶.env.exampleå¹¶é…ç½®"
    exit 1
fi

# åœæ­¢ç°æœ‰æœåŠ¡
echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
pm2 stop encrypted-image-backend || true
pm2 delete encrypted-image-backend || true

# å¯åŠ¨æ–°æœåŠ¡
echo "ğŸ”„ å¯åŠ¨æ–°æœåŠ¡..."
pm2 start ecosystem.config.json

# ä¿å­˜PM2é…ç½®
echo "ğŸ’¾ ä¿å­˜PM2é…ç½®..."
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
echo "ğŸ”§ è®¾ç½®å¼€æœºè‡ªå¯..."
pm2 startup

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“Š æŸ¥çœ‹æœåŠ¡çŠ¶æ€: pm2 status"
echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—: pm2 logs encrypted-image-backend"
echo "ğŸ”„ é‡å¯æœåŠ¡: pm2 restart encrypted-image-backend"